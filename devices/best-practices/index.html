<!DOCTYPE html>

<html class="has-navbar-fixed-top">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="generator" content="Hugo 0.70.0" />
  <title>Best Practices | The Things Stack for LoRaWAN</title><link rel="canonical" href="https://www.thethingsindustries.com/docs/devices/best-practices/" />
  <link rel="alternate icon" href="/docs/favicon.ico">
  <link rel="alternate icon" type="image/png" href="/docs/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/docs/favicon.svg">
  <link rel="stylesheet" href="https://www.thethingsindustries.com/docs/css/theme.min.87592179d2b736be842bb7a3dd97c7a09f561effecbfb81ec0a18685eb1bd4e0.css" integrity="sha256-h1khedK3Nr6EK7ej3ZfHoJ9WHv/sv7gewKGGhesb1OA=">
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta itemprop="name" content="Best Practices">
  <meta itemprop="description" content="">
  <meta itemprop="keywords" content="">
  <meta property="og:title" content="Best Practices">
  <meta property="og:description" content="">
  <meta property="og:url" content="https://www.thethingsindustries.com/docs/devices/best-practices/">
  <meta name="twitter:title" content="Best Practices" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:card" content="summary" />
</head>


<body>

<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div id="migration-info">
      <div id="migration-text">thethingsstack.io has moved to thethingsindustries.com/docs</div>
      <div id="migration-button" class="button is-primary">Got it</div>
  </div>
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/">
        <img class="logo" src="/docs/img/TTS-logo.svg">
        <p class="navbar-item is-size-7">v3.10</p>
      </a>
      <span class="navbar-burger burger" data-target="topMenu">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    <div id="topMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/docs/getting-started/">Getting Started</a>
        <a class="navbar-item" href="/docs/devices/">Devices</a>
        <a class="navbar-item" href="/docs/gateways/">Gateways</a>
        <a class="navbar-item" href="/docs/integrations/">Integrations</a>
        <a class="navbar-item" href="/docs/reference/">Reference</a>
      </div>
      <div class="navbar-end"><div class="navbar-item">
            <a class="button is-primary" href="/docs/download/">Get The Things Stack</a>
          </div>
      </div>
    </div>
  </div>
</nav>


<main>
<section class="section">
  <div class="container">
    <div class="columns">
      
      <div class="column is-one-third">


<h2 class="title is-size-4">Best Practices</h2>

<ul class="menu-list">
<a href="https://www.thethingsindustries.com/docs/devices/best-practices/" class="is-active">Overview</a>
</ul>





      </div>
      
      <div class="column is-two-thirds">

<h1 class="title is-size-2">Best Practices


</h1>

<div class="content">

<p>This section contains best practices for building connected devices which use The Things Stack as a Network Server.</p>
<p>LoRaWAN devices should always comply to the <a href="https://www.lora-alliance.org/lorawan-for-developers">LoRaWAN specification</a>.</p>
<p>The goal of these best practices is to optimize individual devices (especially for power) and the network as a whole (to reliably and efficiently serve more devices with the same number of gateways).</p>
<h2 id="eliminate-unnecessary-join-requests">Eliminate Unnecessary Join Requests</h2>
<p>The LoRaWAN specification warns specifically against systematic rejoin in case of network failure. A device should keep the result of an activation in permanent storage if the device is expected to be power-cycled during its lifetime.</p>
<p>A device may temporarily lose connection with the network for many reasons: if the network server or gateways are suffering from an outage, if there’s no coverage in the area, etc. Whenever a device rejoins, it consumes the closest gateway’s airtime to emit the downlink - and if many devices in an area are rejoining at the same time (e.g. in case of a temporary gateway outage), this leads to network bloating in the area.</p>
<p>More best practices for joins are available in the LoRa Developer Reference <a href="https://lora-developers.semtech.com/library/tech-papers-and-guides/the-book/joining-and-rejoining">here</a>.</p>
<h2 id="limit-transmission-length-payload-size-and-duty-cycle">Limit Transmission Length, Payload Size, and Duty Cycle</h2>
<p>Limit the frequency of your transmissions to the minimum possible. Can you sample data once a day? Or even less?</p>
<p>Optimize message encoding for size. Shorter messages mean shorter transmission time.</p>
<p>Avoid confirmed uplink messages. Confirmed uplinks should only be used in the case where 100% assurance of transmission is necessary, e.g. alarms.</p>
<p>The duty cycle of radio devices is often regulated by government. If this is the case, the duty cycle is commonly set to 1%, but make sure to check the regulations of your local government to be sure.</p>
<p>For example, in Europe, duty cycles are regulated by section 7.2.3 of the ETSI EN300.220 standard.</p>
<p>Additionally, the LoRaWAN specification dictates duty cycles for the join frequencies, the frequencies devices of all LoRaWAN-compliant devices use for over-the-air activation (OTAA). In most regions this duty cycle is set to 1%.</p>
<h2 id="expect-packet-loss">Expect Packet Loss</h2>
<p>You should expect packet loss up to 10%. Implement Forward Error Correction if that&rsquo;s a problem.</p>
<h2 id="synchronization-backoff-and-jitter">Synchronization, Backoff, and Jitter</h2>
<p>(<a href="https://lora-alliance.org/sites/default/files/2018-07/lorawan1.0.3.pdf">See LoRaWAN Specification 1.0.3, line 1065</a>).</p>
<p>Synchronization of devices happens if end devices respond to a large-scale external event - for example, hundreds of end devices that are connected to the same power source and the power is switched off and on again, or hundreds of end devices that are connected to the same gateway, and the firmware of the gateway needs to be updated.</p>
<p>Let’s take an example device that starts in Join mode when it powers on, and reverts to Join mode after being disconnected from the network. There are hundreds of such devices in a field, and one gateway that covers this field.</p>
<p>The power source for the devices is switched on, and the gateway immediately receives the noise of hundreds of simultaneous Join requests. LoRaWAN gateways can deal quite well with noise, but this is just too much, and the gateway can’t make any sense of it. No Join requests are decoded, so no Join requests are forwarded to the network and no Join requests are accepted.</p>
<p>If the retry interval is a fixed duration, e.g. 10 seconds, the gateway again receives the noise of hundreds of simultaneous Join requests, and still can’t make anything of it. This continues every 10 seconds after that, and the entire site stays offline.</p>
<h3 id="jitter">Jitter</h3>
<p>This situation can be improved by using jitter. Instead of sending a Join request every 10 seconds, the devices send a Join request 10 seconds after the previous one, plus or minus a random duration of 0-20% of this 10 seconds. This jitter percentage needs to be truly random, because if all devices use the same pseudorandom number generator, they will still be synchronized, as they will all pick the same “random” number.</p>
<p>With these improved devices, the Join requests will no longer all be sent at exactly the same time, and the gateway will have a better chance of decoding the Join requests.</p>
<h3 id="backoff">Backoff</h3>
<p>But what if you have another site with thousands of these devices? Then the 10 seconds between Join messages may not be enough. This is where backoff comes in. Instead of having a delay of 10s±20%, you increase the delay after each attempt, so you do the second attempt after 20s±20%, the third after 30s±20%, and you keep increasing the delay until you have, say, 1h±20% between Join requests.</p>
<p>An implementation like this prevents persistent failures of sites and the network as a whole and helps speed up recovery after outages.</p>
<h2 id="use-a-good-random-number-generator">Use a Good Random Number Generator</h2>
<p>True randomness in a device&rsquo;s random number generator is especially important for preventing network congestion. If devices share a seed for a pseudorandom number generator, they will choose the same random numbers. Devices should use a unique seed such as the device address.</p>
<p>Bad randomization will result in an uneven distribution of channels selected for random channel selection, causing subpar network performance. (<a href="https://lora-alliance.org/sites/default/files/2018-07/lorawan1.0.3.pdf">LoRaWAN Specification 1.0.3, line 244</a>).</p>
<p>Bad randomization will also result in transmission synchronization if devices respond to a large scale external event (for example, if they are all powered on at the same time).</p>
<h2 id="use-adr-for-stationary-devices">Use ADR for Stationary Devices</h2>
<p>For devices that don&rsquo;t move, the LoRaWAN specification recommends allowing the Network Server to control the data rate to minimize power consumption.</p>
<p>For moving devices, ADR should not be used since RF conditions will likely change, but since many moving devices are temporarily stationary, it is possible to save additional power by requesting ADR only during the time a device is stationary. (<a href="https://lora-alliance.org/sites/default/files/2018-07/lorawan1.0.3.pdf">LoRaWAN Specification 1.0.3, line 438</a>).</p>
<p>You may also use application specific knowledge to predict when ADR is appropriate. A tracking device can detect when it is moving, for example. A parked car sensor can detect when a parked car will affect RF conditions, and should fall back to another strategy.</p>
<h2 id="use-otaa">Use OTAA</h2>
<p>OTAA devices perform a join-procedure with the network, during which a dynamic Device Address is assigned and security keys are negotiated with the device. Activation by Personalization (ABP) requires hardcoding the Device Address as well as the security keys in the device, which is insecure. ABP also has the downside that devices can not switch network providers without manually changing keys in the device.</p>
<h2 id="power-cycles">Power Cycles</h2>
<p>Devices should save network parameters between regular power cycles. This includes session parameters like <code>DevAddr</code>, session keys, <code>FCnt</code>, and nonces. This allows the device to easily Join, as keys and counters remain synchronized.</p>
<p>Devices should also randomize initial power on delay (i.e. Join). See <a href="#synchronization-backoff-jitter">Synchronization, Backoff, and Jitter</a></p>
<h2 id="frame-counters">Frame Counters</h2>
<p>Devices must increment the frame counter after each uplink and downlink. Devices should use 32 bit counters for FCntUp and FCntDwn to prevent replay attacks.</p>
<h2 id="ack">Ack</h2>
<p>It is possible that you will not receive an ACK for every confirmed uplink or downlink. A good rule of thumb is to wait for at least <strong>three</strong> missed ACK&rsquo;s to assume link loss.</p>
<p>In the case of link loss, do the following:</p>
<ul>
<li>Set TX power to the maximum allowed/supported, and try again</li>
<li>Decrease data rate step by step, and try again</li>
<li>Reset to default channels, and try again</li>
<li>Send periodic join requests with backoff</li>
</ul>
</div>






<div class="is-clearfix">
</div>




      </div>
    </div>
  </div>
</section>
</main>

<footer class="footer background-footer">
  <div class="container">
    <div class="columns">
      <nav class="column is-one-quarter">
        <h3 class="title is-6">The Things Stack</h3>
        <p><a class="" href="/docs/getting-started/">Getting Started</a></p>
        <p><a class="" href="/docs/devices/">Devices</a></p>
        <p><a class="" href="/docs/gateways/">Gateways</a></p>
        <p><a class="" href="/docs/integrations/">Integrations</a></p>
        <p><a class="" href="/docs/reference/">Reference</a></p>
      </nav>
      <nav class="column is-one-quarter">
        <h3 class="title is-6">Contributing</h3>
        <p><a class="" href="https://github.com/TheThingsIndustries/lorawan-stack-docs">GitHub</a></p>
        <p><a class="" href="https://www.thethingsnetwork.org/forum/c/network-and-routing/v3">Forum</a></p>
      </nav>
      
      <nav class="column is-one-quarter">
        <h3 class="title is-6">About Us</h3>
        <p><a class="" href="https://www.thethingsnetwork.org">The Things Network</a></p>
        <p><a class="" href="https://www.thethingsindustries.com">The Things Industries</a></p>
      </nav>
      <div class="column is-one-quarter">
        <h3 class="title is-6">About this page</h3>
        <div class="content">
<p class="is-size-7">
  Last changed by benolayinka on 30 Sep 2020.
  <br>
  <a href="https://github.com/TheThingsIndustries/lorawan-stack-docs/commit/10f101d37ce3bb7c1c083f1355c6c2637a0a2c3b">
      Add device best practices
    </a>
</p>

<a href="https://github.com/TheThingsIndustries/lorawan-stack-docs/blob/master/doc/content/devices/best-practices/_index.md" class="button">Edit on Github</a>
</div>

      </div>
    </div>
  </div>
</footer>
<script src="https://www.thethingsindustries.com/docs/js/vendor/basicLightbox.min.js"></script>
<script src="https://www.thethingsindustries.com/docs/js/theme.min.e9df3c06e815b9686686212e86bfd0217a508f5ccee0139d7bc899ef7460191e.js" integrity="sha256-6d88BugVuWhmhiEuhr/QIXpQj1zO4BOde8iZ73RgGR4="></script>

</body>

</html>
